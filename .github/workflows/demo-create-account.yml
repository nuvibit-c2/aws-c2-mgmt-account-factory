name: DEMO CREATE ACCOUNT

on: 
  workflow_dispatch:
    inputs:
      port_payload:
        required: true
        description: Port's payload, including details for who triggered the action and general context (blueprint, run id, etc...)
        type: string

jobs:
  demo-create-account:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Update Account List
        run: |
          account_list=$(cat account_list.json)
          new_account=$(cat <<EOF
          [{
              "account_name": "${{fromJson(inputs.port_payload).payload.properties.account_name}}",
              "account_email": "${{fromJson(inputs.port_payload).payload.properties.account_email}}",
              "ou_path": "/root/solutions/${{fromJson(inputs.port_payload).payload.properties.workload_stage}}",
              "close_on_deletion": true,
              "account_tags": {
                  "AccountOwner": "${{fromJson(inputs.port_payload).trigger.by.user.email}}",
                  "AccountType": "workload",
                  "AccountDescription": "This is a demo account",
                  "CostCenter": "${{fromJson(inputs.port_payload).payload.properties.cost_center_id}}"
              },
              "alternate_contacts": [
                  {
                      "type": "SECURITY",
                      "name": "Security Contact",
                      "email_address": "${{fromJson(inputs.port_payload).payload.properties.security_contact_email}}"
                  }
              ]
          }]
          EOF)
          new_account_list=$(echo "$account_list" | jq --argjson newAcc "$new_account" '. += [$newAcc]')
          echo "$new_account_list" > $account_list_path

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Demo: adding new aws account '${{fromJson(inputs.port_payload).payload.properties.account_name}}'"
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          delete-branch: true
          title: "[DEMO] Create AWS Account '${{fromJson(inputs.port_payload).payload.properties.account_name}}'"
          reviewers: stefano-franco
          labels: Demo
          branch: demo-${{fromJson(inputs.port_payload).context.runId}}
          add-paths: account_list.json